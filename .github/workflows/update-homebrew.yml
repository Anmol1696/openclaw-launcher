name: Update Homebrew Cask

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true

jobs:
  update-cask:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download DMG and calculate SHA256
        id: sha
        run: |
          curl -L -o OpenClawLauncher.dmg \
            "https://github.com/Anmol1696/openclaw-launcher/releases/download/${{ steps.release.outputs.tag }}/OpenClawLauncher.dmg"
          SHA256=$(shasum -a 256 OpenClawLauncher.dmg | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: Anmol1696/homebrew-openclaw-launcher
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update cask formula
        run: |
          cd homebrew-tap
          cat > Casks/openclaw-launcher.rb << 'EOF'
          cask "openclaw-launcher" do
            version "${{ steps.release.outputs.version }}"
            sha256 "${{ steps.sha.outputs.sha256 }}"

            url "https://github.com/Anmol1696/openclaw-launcher/releases/download/v#{version}/OpenClawLauncher.dmg"
            name "OpenClaw Launcher"
            desc "Native macOS launcher for OpenClaw AI Gateway"
            homepage "https://github.com/Anmol1696/openclaw-launcher"

            depends_on macos: ">= :sonoma"

            app "OpenClawLauncher.app"

            zap trash: "~/.openclaw-launcher"
          end
          EOF

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/openclaw-launcher.rb
          git commit -m "Update openclaw-launcher to ${{ steps.release.outputs.version }}"
          git push
